<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sanctions Search</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 24px; max-width: 1000px; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
      label { display: grid; gap: 6px; font-size: 14px; }
      input, select { padding: 10px; font-size: 14px; min-width: 240px; }
      button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
      .meta { margin-top: 16px; padding: 12px; background: #f6f6f6; border-radius: 8px; }
      table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
      th { background: #fafafa; }
      .error { color: #b00020; margin-top: 12px; white-space: pre-wrap; }
      .muted { color: #666; }
      .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eee; font-size: 12px; }
    </style>
  </head>
  <body>
    <h1>Sanctions Search</h1>

    <div class="row">
      <label>
        Client name / term
        <input id="query" placeholder="e.g. David Thomas Mhoja" />
      </label>

      <label>
        Min score threshold
        <input id="minScore" type="number" value="90" min="0" max="100" />
      </label>

      <label>
        Owner type
        <select id="ownerType">
          <option value="CLIENT" selected>CLIENT</option>
          <option value="LOAN_ACCOUNT">LOAN_ACCOUNT</option>
        </select>
      </label>

      <label>
        Recipient ID (only for LOAN_ACCOUNT)
        <input id="recipientId" type="number" placeholder="e.g. 123" />
      </label>

      <label>
        Client ID (optional)
        <input id="clientId" placeholder="optional client_id" />
      </label>

      <label>
        Include report
        <select id="includeReport">
          <option value="false" selected>false</option>
          <option value="true">true</option>
        </select>
      </label>

      <button id="btn">Search</button>
    </div>

    <div id="error" class="error"></div>

    <div id="meta" class="meta" style="display:none;"></div>

    <table id="tbl" style="display:none;">
      <thead>
        <tr>
          <th>Source</th>
          <th>Name</th>
          <th>Type</th>
          <th>Programs</th>
          <th>Score</th>
          <th>Match details</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <script>
      const BACKEND_URL = "http://localhost:8000"; // change if needed
      const endpoint = `${BACKEND_URL}/sanctions/search`;

      const el = (id) => document.getElementById(id);

      function setLoading(isLoading) {
        el("btn").disabled = isLoading;
        el("btn").textContent = isLoading ? "Searching..." : "Search";
      }

      function renderResponse(data) {
        el("error").textContent = "";
        el("meta").style.display = "block";
        el("meta").innerHTML = `
          <div><strong>Query:</strong> ${data.query ?? ""}</div>
          <div><strong>Success:</strong> ${data.success ? "Yes" : "No"}</div>
          <div><strong>Matches found:</strong> ${data.matches_found ?? 0}</div>
          <div><strong>Min score threshold:</strong> ${data.min_score_threshold ?? ""}</div>
          <div class="muted"><strong>Report:</strong> ${data.report_created ? "Created" : "Not created"} ${data.report_filename ? `<span class="pill">${data.report_filename}</span>` : ""}</div>
        `;

        const results = Array.isArray(data.results) ? data.results : [];
        el("tbl").style.display = results.length ? "table" : "none";
        const tbody = el("tbody");
        tbody.innerHTML = "";

        for (const r of results) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.source ?? ""}</td>
            <td>${r.name ?? ""}</td>
            <td>${r.type ?? ""}</td>
            <td>${Array.isArray(r.programs) ? r.programs.join(", ") : (r.programs ?? "")}</td>
            <td>${r.score ?? ""}</td>
            <td>${r.match_details ?? ""}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      async function search() {
        const query = el("query").value.trim();
        const minScore = Number(el("minScore").value || 90);
        const ownerType = el("ownerType").value;
        const recipientIdRaw = el("recipientId").value.trim();
        const clientId = el("clientId").value.trim();
        const includeReport = el("includeReport").value === "true";

        el("error").textContent = "";
        el("meta").style.display = "none";
        el("tbl").style.display = "none";

        if (!query) {
          el("error").textContent = "Please enter a name/term to search.";
          return;
        }

        const payload = {
          query,
          min_score_threshold: minScore,
          include_report: includeReport,
          owner_type: ownerType,
          client_id: clientId || ""
        };

        // Only send recipient_id if relevant
        if (ownerType === "LOAN_ACCOUNT" && recipientIdRaw) {
          payload.recipient_id = Number(recipientIdRaw);
        }

        setLoading(true);
        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // IMPORTANT: donâ€™t send cookies unless you intentionally need them
            credentials: "omit",
            body: JSON.stringify(payload),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            el("error").textContent =
              `Request failed (HTTP ${res.status}).\n` +
              JSON.stringify(data, null, 2);
            return;
          }

          renderResponse(data);
        } catch (err) {
          el("error").textContent = `Network error: ${err?.message ?? err}`;
        } finally {
          setLoading(false);
        }
      }

      el("btn").addEventListener("click", search);
      el("query").addEventListener("keydown", (e) => {
        if (e.key === "Enter") search();
      });
    </script>
  </body>
</html>
